@using System
@using System.Linq
@using System.Globalization
@using Digital_Library.Core.Enum
@using Digital_Library.Core.Enums
@model IEnumerable<Digital_Library.Core.Models.OrderHeader>

@{
 ViewData["Title"] = "My Orders";

 var headers = (Model ?? Enumerable.Empty<Digital_Library.Core.Models.OrderHeader>()).ToList();

 Func<Digital_Library.Core.Models.OrderHeader, decimal> HeaderTotal = h =>
     h?.OrderDetails?.Sum(d => d.Price * d.Quantity) ?? 0m;

 var totalSpent = headers.Sum(HeaderTotal);
 var statusGroups = headers
     .GroupBy(h => h.Status)
     .Select(g => new { Status = g.Key, Count = g.Count() })
     .OrderByDescending(g => g.Count)
     .ToList();

 string FormatCurrency(decimal amount) => amount.ToString("C");
}

<style>
 .orders-page {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 3px 15px rgba(0,0,0,0.12);
  padding: 24px;
 }

 .orders-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 18px;
  flex-wrap: wrap;
 }

 .orders-title {
  font-size: 26px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
 }

 .summary {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-bottom: 14px;
 }

 .summary-card {
  background: #f7f9fc;
  border: 1px solid #e6ecf5;
  border-radius: 10px;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
 }

 .status-chips {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
 }

 .chip {
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  border: 1px solid #e6ecf5;
  background: #fafbff;
 }

 .filters {
  display: grid;
  grid-template-columns: 1.3fr 0.8fr 0.8fr 0.8fr auto;
  gap: 10px;
  margin: 14px 0 12px;
 }

  .filters input, .filters select, .filters button {
   padding: 9px 10px;
   border-radius: 8px;
   border: 1px solid #d9e0ea;
   font-size: 14px;
  }

  .filters button {
   background: #0d6efd;
   color: white;
   border: none;
   cursor: pointer;
  }

   .filters button.clear {
    background: #6c757d;
   }

 table.orders-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
 }

 .orders-table th, .orders-table td {
  padding: 12px 10px;
  border-bottom: 1px solid #eef2f6;
  vertical-align: middle;
 }

 .orders-table th {
  text-align: left;
  color: #4b5563;
  font-weight: 600;
  background: #f9fbfd;
 }

 .muted {
  color: #6b7280;
  font-size: 12px;
 }

 .status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid transparent;
 }

 .status-pending {
  background: #fff7ed;
  color: #9a3412;
  border-color: #fdba74;
 }

 .status-processing, .status-paid {
  background: #eff6ff;
  color: #1d4ed8;
  border-color: #93c5fd;
 }

 .status-completed, .status-shipped {
  background: #ecfdf5;
  color: #065f46;
  border-color: #6ee7b7;
 }

 .status-cancelled, .status-rejected, .status-failed {
  background: #fef2f2;
  color: #991b1b;
  border-color: #fecaca;
 }

 .status-refunded {
  background: #f5f3ff;
  color: #5b21b6;
  border-color: #ddd6fe;
 }

 .actions .btn {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #fff;
  cursor: pointer;
  font-size: 13px;
 }

  .actions .btn:hover {
   background: #f3f4f6;
  }

 .btn-toggle {
  background: #eef2ff;
  border-color: #c7d2fe;
 }

 .btn-view {
  background: #fff;
 }

 .items-container {
  padding: 12px 12px 0;
  background: #fafafa;
  border: 1px dashed #e5e7eb;
  border-radius: 8px;
 }

 .item {
  display: grid;
  grid-template-columns: 56px 2fr 1fr 1fr;
  gap: 10px;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
 }

  .item:last-child {
   border-bottom: none;
  }

  .item img {
   width: 56px;
   height: 56px;
   object-fit: cover;
   border-radius: 6px;
  }

  .item .title {
   font-weight: 600;
  }

  .item .meta {
   color: #6b7280;
   font-size: 12px;
  }

 @@media (max-width: 900px) {
  .filters {
   grid-template-columns: 1fr 1fr;
  }

  .orders-header {
   flex-direction: column;
   align-items: flex-start;
  }

  .item {
   grid-template-columns: 56px 1fr;
   grid-auto-rows: auto;
  }
 }
</style>

<div class="orders-page">
 <div class="orders-header">
  <div class="orders-title">🧾 My Orders</div>
  <div class="summary">
   <div class="summary-card">
    <span>Shipments:</span>
    <strong id="orders-count">@headers.Count</strong>
   </div>
   <div class="summary-card">
    <span>Total spent (by shipments):</span>
    <strong id="orders-revenue">@FormatCurrency(totalSpent)</strong>
   </div>
   <div class="status-chips">
    @foreach (var g in statusGroups)
    {
     <div class="chip">@g.Status (@g.Count)</div>
    }
   </div>
  </div>
 </div>

 <div class="filters">
  <input type="text" id="searchInput" placeholder="Search by Order ID or Vendor..." />
  <select id="statusFilter">
   <option value="">All Statuses</option>
   @foreach (var s in Enum.GetValues(typeof(Status)).Cast<Status>())
   {
    <option value="@s">@s</option>
   }
  </select>
  <input type="date" id="startDate" />
  <input type="date" id="endDate" />
  <div style="display:flex; gap:8px;">
   <button id="applyFilters">Filter</button>
   <button class="clear" id="clearFilters">Clear</button>
  </div>
 </div>

 @if (!headers.Any())
 {
  <div class="text-center py-4" style="padding: 24px; text-align:center;">
   <div>You have no orders yet.</div>
  </div>
 }
 else
 {
  <table class="orders-table" id="ordersTable">
   <thead>
    <tr>
     <th>Order</th>
     <th>Date</th>
     <th>Vendor</th>
     <th>Status</th>
     <th class="text-end" style="text-align:right;">Items</th>
     <th class="text-end" style="text-align:right;">Total</th>
     <th>Actions</th>
    </tr>
   </thead>
   <tbody>
    @foreach (var h in headers.OrderByDescending(h => h.Order?.OrderDate))
    {
     var order = h.Order;
     var vendorName = h.Vendor?.User.FullName ?? "N/A";
     var statusText = h.Status.ToString();
     var statusCss = $"status-{statusText.ToLower()}";
     var itemsCount = h.OrderDetails?.Sum(d => d.Quantity) ?? (h.OrderDetails?.Count ?? 0);
     var dateIso = order?.OrderDate.ToString("s", CultureInfo.InvariantCulture) ?? "";
     var headerTotal = HeaderTotal(h);
     var totalInvariant = headerTotal.ToString(CultureInfo.InvariantCulture);

     <tr class="order-row"
         data-orderid="@h.OrderId"
         data-oid="@h.Id"
         data-vendor="@vendorName"
         data-status="@statusText"
         data-date="@dateIso"
         data-total="@totalInvariant">
      <td>
       <div style="display:flex; flex-direction:column;">
        <div style="display:flex; align-items:center; gap:8px;">
         <code>@h.OrderId</code>
         <button class="btn btn-copy" data-copy="@h.OrderId" title="Copy Order ID">Copy</button>
        </div>
        <span class="muted">Shipment: @h.Id</span>
       </div>
      </td>
      <td>
       @if (order != null)
       {
        <div>@order.OrderDate.ToString("MMM dd, yyyy")</div>
        <div class="muted">@order.OrderDate.ToString("HH:mm")</div>
       }
       else
       {
        <div>N/A</div>
       }
      </td>
      <td>@vendorName</td>
      <td><span class="status-badge @statusCss">@statusText</span></td>
      <td style="text-align:right;">@itemsCount</td>
      <td style="text-align:right;"><strong>@FormatCurrency(headerTotal)</strong></td>
      <td class="actions" style="display:flex; gap:6px;">
       <button class="btn btn-toggle" type="button">Items</button>
       <button class="btn btn-view" onclick="location.href='@Url.Action("MyOrderDetails", "Order", new { id = h.Id })'">Details</button>
      </td>
     </tr>

     <tr class="order-items" style="display:none;">
      <td colspan="7">
       <div class="items-container">
        @if (h.OrderDetails != null && h.OrderDetails.Any())
        {
         foreach (var d in h.OrderDetails)
         {
          var book = d.Book;
          var cover = book?.ImageBookCoverPath ?? "";
          var title = book?.Title ?? "Unknown Book";
          var format = d.FormatType.ToString();
          var lineTotal = d.Price * d.Quantity;

          <div class="item">
           <div>
            @if (!string.IsNullOrWhiteSpace(cover))
            {
             <img src="~/@cover" alt="@title" />
            }
           </div>
           <div>
            <div class="title">@title</div>
            <div class="meta">Format: @format</div>
           </div>
           <div class="meta">Qty: @d.Quantity</div>
           <div style="text-align:right;">
            <div>@FormatCurrency(d.Price)</div>
            <div class="meta">Total: @FormatCurrency(lineTotal)</div>
           </div>
          </div>
         }
        }
        else
        {
         <div class="muted">No items found for this shipment.</div>
        }

        @if (order != null)
        {
         <div style="margin-top:12px; display:flex; gap:24px; flex-wrap:wrap;" class="muted">
          <div>Ship to: @order.Address</div>
          <div>Phone: @order.PhoneNumber</div>
         </div>
        }
       </div>
      </td>
     </tr>
    }
   </tbody>
  </table>
 }
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
 (function(){
     function toNumber(val){ const n = parseFloat(val); return isNaN(n) ? 0 : n; }
     function inRange(date, start, end){
         if(!start && !end) return true;
         if(start && date < start) return false;
         if(end && date > end) return false;
         return true;
     }

     function applyFilters(){
         const $rows = $('#ordersTable .order-row');
         const q = ($('#searchInput').val() || '').toString().trim().toLowerCase();
         const status = ($('#statusFilter').val() || '').toString();
         const startStr = $('#startDate').val();
         const endStr = $('#endDate').val();

         const start = startStr ? new Date(startStr + 'T00:00:00') : null;
         const end = endStr ? new Date(endStr + 'T23:59:59') : null;

         let visible = 0;
         let sum = 0;

         $rows.each(function(){
             const $r = $(this);
             const orderId = ($r.data('orderid') || '').toString().toLowerCase();
             const vendor = ($r.data('vendor') || '').toString().toLowerCase();
             const st = ($r.data('status') || '').toString();
             const dtStr = ($r.data('date') || '').toString();
             const dt = dtStr ? new Date(dtStr) : null;
             const total = toNumber($r.data('total'));

             const matchesSearch = !q || orderId.includes(q) || vendor.includes(q);
             const matchesStatus = !status || st === status;
             const matchesDate = !dt || inRange(dt, start, end);

             const show = matchesSearch && matchesStatus && matchesDate;
             $r.toggle(show);
             $r.next('.order-items').toggle(show && $r.next('.order-items').data('expanded') === true);

             if(show){ visible++; sum += total; }
         });

         $('#orders-count').text(visible);
         $('#orders-revenue').text(new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(sum));
     }

     $('#applyFilters').on('click', applyFilters);
     $('#clearFilters').on('click', function(){
         $('#searchInput').val('');
         $('#statusFilter').val('');
         $('#startDate').val('');
         $('#endDate').val('');
         applyFilters();
     });

     $('#searchInput, #statusFilter, #startDate, #endDate').on('change keyup', function(e){
         if(e.type === 'keyup' && e.key !== 'Enter') return;
         applyFilters();
     });

     // Toggle items row
     $(document).on('click', '.btn-toggle', function(){
         const $row = $(this).closest('tr');
         const $items = $row.next('.order-items');
         const isVisible = $items.is(':visible');
         $items.data('expanded', !isVisible);
         $items.toggle(!isVisible);
     });

     // Copy Order ID
     $(document).on('click', '.btn-copy', async function(){
         const text = $(this).data('copy');
         try {
             await navigator.clipboard.writeText(text);
             const old = $(this).text();
             $(this).text('Copied!');
             setTimeout(() => $(this).text(old), 1000);
         } catch {
             alert('Could not copy');
         }
     });
 })();
</script>